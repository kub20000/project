<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공지사항 수정</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>
    <header>
        <h1>Vegan Delight - 관리자 mode</h1>
        <nav>
            <a th:href="@{/admin/indexmg}">홈</a>
            <a th:href="@{/admin/post}">게시판</a>
            <a th:href="@{/admin/usermng}">회원관리</a>
        </nav>
    </header>
    <main class="form-container">
            <h2>공지사항 수정</h2>
        <form id="post-editForm" th:action="@{/admin/post-edit}" th:object="${post}" method="post">
            <input type="hidden" th:field="*{id}">
            <div class="form-row">
                <label for="title">제목</label>
                <input type="text" id="title" th:field="*{title}" required>
            </div>

            <div class="form-row column">
                <label for="content">내용</label>
                <textarea id="content" th:field="*{content}" rows="8" required></textarea>
            </div>

            <div class="form-actions">
                <button type="submit">저장</button>
                <button type="button" onclick="window.location.href='/admin/post'">취소</button>
            </div>
        </form>
    </main>

    <script>
        // URL에서 id 가져오기
        const pathSegments = window.location.pathname.split("/");
        const id = Number(pathSegments[pathSegments.length - 1]);

        // localStorage 예제 (백엔드 연동 시 fetch로 대체 가능)
        let posts = JSON.parse(localStorage.getItem("posts")) || [];
        const post = posts.find(p => p.id === id);

        if (post) {
            document.getElementById("title").value = post.title;
            document.getElementById("content").value = post.content;
        }

        // form id 맞춤
        document.getElementById("post-editForm").addEventListener("submit", async function(e){
            e.preventDefault();

            const postData = {
                id: id,
                title: document.getElementById("title").value,
                content: document.getElementById("content").value
            };

            try {
                const res = await fetch(`/api/post/${id}`, {
                    method: "PUT",
                    headers: {"Content-Type":"application/json"},
                    body: JSON.stringify(postData)
                });

                console.log("post " + id);

                if(res.ok){
                    alert("수정이 완료되었습니다.");
                    console.log("PUT 요청 URL:", `/api/post/${id}`, "id:", id, "postData:", postData);
                    window.location.href = '/admin/post'; // 수정 후 목록 페이지로 이동
                } else {
                    alert("수정 실패! 상태 코드**: " + res.status);
                }
            } catch (error) {
                console.error("수정 중 오류 발생:", error);
                alert("수정 중 오류가 발생했습니다.");
            }
        });
    </script>
</body>

</html>