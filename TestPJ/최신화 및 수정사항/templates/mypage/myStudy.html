<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ í•™ìŠµ ê¸°ë¡</title>
    <link rel="stylesheet" href="/css/styleMy.css">
    <!-- í°íŠ¸ ì–´ì¸ ì•„ì´ì½˜ ì‚¬ìš©ì„ ìœ„í•œ ë§í¬ (í•„ìš” ì‹œ ì¶”ê°€) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>

<body>
<div th:replace="fragments/mainheader :: mainHeader"></div>

<div class="page-wrapper">
    <nav th:replace="fragments/mypageheader :: sitenav"></nav>

    <main class="board-container">
        <h2>ë‚´ í•™ìŠµ ê¸°ë¡</h2>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ í•™ìŠµ ì§„ë„ìœ¨ ì„¹ì…˜ -->
        <div class="progress-section">
            <h3>ì¹´í…Œê³ ë¦¬ë³„ í•™ìŠµ ì§„ë„ìœ¨</h3>
            <div class="progress-grid">
                <!-- loginUserì˜ progressListë¥¼ ë°˜ë³µí•˜ì—¬ ì¶œë ¥í•©ë‹ˆë‹¤. -->
                <div class="progress-card" th:each="progress : ${progressList}">
                    <div class="card-header">
                        <span class="icon"
                              th:text="${progress.category == 'LIFE' ? 'ğŸŒ±' :
                                     (progress.category == 'RECIPE' ? 'ğŸ³' :
                                     (progress.category == 'SKILL' ? 'ğŸ”ª' : 'â“'))}">
                            â“
                        </span>
                        <span class="title"
                              th:text="${progress.category == 'LIFE' ? 'ë¹„ê±´ ë¼ì´í”„ ìŠ¤íƒ€ì¼' :
                                     (progress.category == 'RECIPE' ? 'ìš”ë¦¬ ë ˆì‹œí”¼' :
                                     (progress.category == 'SKILL' ? 'ì¡°ë¦¬ ìŠ¤í‚¬' : 'ê¸°íƒ€'))}">
                            ì¹´í…Œê³ ë¦¬ ì´ë¦„
                        </span>
                    </div>

                    <div class="progress-bar">
                        <!-- ê²Œì´ì§€ ë§‰ëŒ€ -->
                        <div class="progress" th:style="'width: ' + ${progress.rate} + '%;'">
                        </div>
                        <!-- ì¤‘ì•™ ê³ ì • í…ìŠ¤íŠ¸ -->
                        <span class="progress-rate-text" th:text="${progress.rate} + '%'">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <!--  ê°•ì˜ íƒ­: data-tab ì†ì„± ìœ ì§€  -->
        <div class="stydy-tabs">
            <button class="stydy-tab active" data-tab="recent">ìµœê·¼ ë³¸ ê°•ì˜</button>
            <button class="stydy-tab" data-tab="completed">ì™„ë£Œí•œ ê°•ì˜</button>
        </div>

        <!-- 'ìµœê·¼ ë³¸ ê°•ì˜' íƒ­ ë‚´ìš©  -->
        <div id="recentContent" class="stydy-tab-content active">

            <div class="course-list reveal">
                <!-- ê¸°ì¡´ Thymeleaf ë¦¬ìŠ¤íŠ¸ ë°˜ë³µë¬¸ ìœ ì§€ -->
                <div class="course-card" th:each="history : ${historyPage.content}">

                    <a th:href="@{/course/main(searchKeyword=${history.videoTitle})}" class="course-link">
                        <div class="thumb">
                            <img th:src="${history.thumbnail_url}" th:alt="${history.videoTitle} + ' ì¸ë„¤ì¼'"
                                 style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                    </a>

                    <div class="course-body">
                        <div class="course-info">
                            <a th:href="@{/course/main(searchKeyword=${history.videoTitle})}">
                                <h3 th:text="${history.videoTitle}">ê°•ì˜ ì œëª©</h3>
                            </a>

                            <div class="actions">
                                <div class="meta-info">
                            <span class="badge category"
                                  th:text="${#temporals.format(history.watched_date, 'yy.MM.dd')}">24.01.01</span>

                                    <span class="badge progress">
                                <i class="fa-solid fa-chart-simple"></i>
                                <span th:text="${history.progress_rate} + '%'">50%</span>
                            </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="progress-bar-small">
                        <div class="progress"
                             th:style="'width: ' + ${history.progress_rate} + '%;'">
                        </div>
                    </div>

                </div>

                <div th:if="${historyPage.content.isEmpty()}" style="padding: 20px; text-align: center; width: 100%;">
                    <p>ìµœê·¼ ë³¸ ì˜ìƒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <div class="pagination" th:if="${historyPage.totalPages > 1}">
                <!-- ê¸°ì¡´ í˜ì´ì§• ë¡œì§ ìœ ì§€ -->
                <a th:if="${historyPage.hasPrevious()}"
                   th:href="@{/mypage/myStudy(page=${historyPage.number - 1})}"
                   class="prev-btn">ì´ì „</a>

                <span th:each="i : ${#numbers.sequence(0, historyPage.totalPages - 1)}">
                    <a th:if="${i >= historyPage.number - 2 and i <= historyPage.number + 2}"
                       th:href="@{/mypage/myStudy(page=${i})}"
                       th:text="${i + 1}"
                       th:class="${i == historyPage.number ? 'active-page' : ''}">1</a>
                </span>

                <a th:if="${historyPage.hasNext()}"
                   th:href="@{/mypage/myStudy(page=${historyPage.number + 1})}"
                   class="next-btn">ë‹¤ìŒ</a>
            </div>
        </div>

        <!-- 'ì™„ë£Œí•œ ê°•ì˜' íƒ­ ë‚´ìš©  -->
        <div id="completedContent" class="stydy-tab-content" style="display: none;">
            <div class="course-list reveal">
                <!-- JavaScriptë¥¼ í†µí•´ ì´ ì•ˆì— ê°•ì˜ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ì‚½ì…ë©ë‹ˆë‹¤. -->
                <div class="initial-message" style="padding: 20px; text-align: center; width: 100%;">
                    <p>ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
                </div>
            </div>
            <!-- ì™„ë£Œ ê°•ì˜ëŠ” í˜„ì¬ í˜ì´ì§•ì„ êµ¬í˜„í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ë¹„ì›Œë‘¡ë‹ˆë‹¤. -->
            <div class="pagination"></div>
        </div>
    </main>
</div>

<!--  JavaScript íƒ­ ì „í™˜ ë° AJAX ë¡œì§  -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabs = document.querySelectorAll('.stydy-tab');
        const recentContent = document.getElementById('recentContent');
        const completedContent = document.getElementById('completedContent');
        const completedListContainer = completedContent.querySelector('.course-list');

        // ë°ì´í„° ë¡œë“œ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜
        let completedDataLoaded = false;

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •: 'ìµœê·¼ ë³¸ ê°•ì˜'ë§Œ ë³´ì„ (HTML style="display: none;"ìœ¼ë¡œ ì´ë¯¸ ì²˜ë¦¬ë¨)

        tabs.forEach(tab => {
            tab.addEventListener('click', (event) => {
                const tabName = event.target.getAttribute('data-tab');

                // íƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
                tabs.forEach(t => t.classList.remove('active'));
                event.target.classList.add('active');

                // ë‚´ìš© ì»¨í…Œì´ë„ˆ í‘œì‹œ/ìˆ¨ê¹€
                if (tabName === 'recent') {
                    recentContent.style.display = 'block';
                    completedContent.style.display = 'none';
                } else if (tabName === 'completed') {
                    recentContent.style.display = 'none';
                    completedContent.style.display = 'block';

                    // ì™„ë£Œëœ ê°•ì˜ ë°ì´í„° ë¡œë“œ (ì²« í´ë¦­ ì‹œì—ë§Œ ë¡œë“œ)
                    if (!completedDataLoaded) {
                        loadCompletedCourses();
                    }
                }
            });
        });

        /**
         * ì™„ë£Œëœ ê°•ì˜ ë°ì´í„°ë¥¼ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë™ì ìœ¼ë¡œ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
         */
        function loadCompletedCourses() {
            // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
            completedListContainer.innerHTML = '<div style="padding: 20px; text-align: center; width: 100%;"><p>ì™„ë£Œëœ ê°•ì˜ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>';

            fetch('/mypage/completedCourses') // Controllerì˜ ìƒˆë¡œìš´ ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
                .then(response => {
                    if (!response.ok) {
                        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                    return response.json();
                })
                .then(data => {
                    completedListContainer.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

                    if (data && data.length > 0) {
                        data.forEach(dto => {
                            // DTO ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¹´ë“œ ìƒì„± ë° ì¶”ê°€
                            const card = createCourseCard(dto);
                            completedListContainer.appendChild(card);
                        });
                        completedDataLoaded = true; // ë¡œë“œ ì™„ë£Œ
                    } else {
                        completedListContainer.innerHTML = '<div style="padding: 20px; text-align: center; width: 100%;"><p>ì•„ì§ ì™„ë£Œí•œ ì˜ìƒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p></div>';
                    }
                })
                .catch(error => {
                    console.error('ì™„ë£Œëœ ê°•ì˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    completedListContainer.innerHTML = '<div style="padding: 20px; text-align: center; width: 100%;"><p>ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (' + error.message + ')</p></div>';
                });
        }

        /**
         * VideoHistoryDto ê°ì²´ë¡œ ê°•ì˜ ì¹´ë“œ HTML ìš”ì†Œë¥¼ ìƒì„±í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
         */
        function createCourseCard(dto) {
            const card = document.createElement('div');
            card.className = 'course-card';

            // 1. ë‚ ì§œ í¬ë§·íŒ…: 'yy.MM.dd' í˜•ì‹
            // dto.watched_dateëŠ” ì„œë²„ì—ì„œ ë„˜ì–´ì˜¨ LocalDateTime ë¬¸ìì—´
            let watchedDateText = '';
            try {
                const date = new Date(dto.watched_date);
                watchedDateText = date.toLocaleDateString('ko-KR', {
                    year: '2-digit', month: '2-digit', day: '2-digit'
                }).replace(/\s/g, '').replace(/\./g, '.').slice(0, -1);
            } catch (e) {
                watchedDateText = 'ë‚ ì§œ ì •ë³´ ì—†ìŒ';
            }

            const videoTitle = dto.videoTitle;
            const thumbnailUrl = dto.thumbnail_url;
            const progressRate = dto.progress_rate; // ì™„ë£Œ ê°•ì˜ì´ë¯€ë¡œ í•­ìƒ 100

            card.innerHTML = `
            <a href="/course/main?searchKeyword=${encodeURIComponent(videoTitle)}" class="course-link">
                <div class="thumb">
                    <img src="${thumbnailUrl}" alt="${videoTitle} ì¸ë„¤ì¼"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
            </a>
            <div class="course-body">
                <div class="course-info">
                    <a href="/course/main?searchKeyword=${encodeURIComponent(videoTitle)}">
                        <h3>${videoTitle}</h3>
                    </a>
                    <div class="actions">
                        <div class="meta-info">
                            <span class="badge progress completed">
                                <i class="fa-solid fa-check-circle"></i>
                                <span>${progressRate}%</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="progress-bar-small">
                <div class="progress" style="width: ${progressRate}%;"></div>
            </div>
        `;
            return card;
        }
    });
</script>
</body>
</html>
