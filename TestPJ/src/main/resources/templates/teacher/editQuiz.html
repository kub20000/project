<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegan LMS - editQuiz</title>
    <link rel="stylesheet" href="/css/styleT.css">
</head>
<body>
<header>
    <h1><a href="/">Vegan Delight</a></h1>
    <nav id="navMenu">
        <a href="/">Home</a>
        <a href="/course/main">Courses</a>
        <a href="/myFridge/main">나의 냉장고</a>
        <a href="login.html">Login</a>
        <a href="/post/main">게시판</a>
        <a href="mypage.html">my page</a>
    </nav>
</header>
<div class="page-wrapper">
    <nav id="subNavT">
        <a href="/teacher/myCourse">나의 강의 관리</a>
        <a href="/teacher/uploadCourse">강의 등록 / 퀴즈 출제</a>
    </nav>
    <main class="editQuiz-container">
        <h2>퀴즈 수정</h2>
        <p style="color:#4caf50; font-weight: 600; margin-right: 6px;">
            강의 제목 :<input type="text" th:value="${course.courses_name}" readonly id="coursesName">
        </p>
        <hr>
        <form id="quizEditForm">
            <input type="hidden" id="coursesId" name="coursesId" th:value="${course.id}">
            <div id="quizWrapper">
            </div>
            <div class="editBtns">
                <button id="editQuiz-btn" type="submit">수정 완료</button>
                <button type="button" onclick="window.history.back()">닫기</button>
            </div>
        </form>
    </main>
</div>
</body>
<script>
    const quizWrapper = document.getElementById("quizWrapper");
    const quizEditForm = document.getElementById("quizEditForm");
    const coursesId = document.getElementById("coursesId").value;
    const coursesName = document.getElementById("coursesName").value; // 추가: 강의 제목을 가져옵니다.

    let quizCount = 0;

    // 서버에서 퀴즈 데이터 가져오기
    fetch(`/quiz/list/${coursesId}`)
        .then(response => response.json())
        .then(quizzes => {
            if (quizzes.length === 0) {
                alert("등록된 퀴즈가 없습니다. 새로 출제해주세요.");
                window.location.href = `/quiz/upload/${coursesId}`;
                return;
            }

            quizzes.forEach((quiz, index) => {
                quizCount++;
                const newCard = document.createElement("div");
                newCard.className = "quiz-card";
                newCard.innerHTML = `
                    <h3>Q${quizCount}.</h3>
                    <input type="hidden" name="quiz_id" value="${quiz.id}">
                    <textarea class="quizCard-area" name="quiz_question" rows="2" placeholder="문제를 입력하세요">${quiz.quiz_question}</textarea>
                    <label style="font-size: large; font-weight: 600;">정답: </label>
                    <input type="text" name="quiz_result" placeholder="정답 입력" value="${quiz.quiz_result}">
                `;
                quizWrapper.appendChild(newCard);
            });
        })
        .catch(error => {
            console.error('Error fetching quizzes:', error);
            alert("퀴즈 정보를 가져오는데 실패했습니다.");
        });

    //  폼 제출(수정 완료) 이벤트 처리
    quizEditForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const quizzesToUpdate = [];
        const quizCards = document.querySelectorAll('.quiz-card');
        quizCards.forEach(card => {
            const quizId = card.querySelector('input[name="quiz_id"]').value;
            const question = card.querySelector('textarea[name="quiz_question"]').value;
            const result = card.querySelector('input[name="quiz_result"]').value;

            quizzesToUpdate.push({
                id: quizId,
                coursesId: coursesId,
                quiz_name: coursesName, // 수정: 강의 제목 변수를 사용합니다.
                quiz_question: question,
                quiz_result: result
            });
        });

        fetch("/quiz/edit", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(quizzesToUpdate)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error("퀴즈 수정에 실패했습니다.");
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                window.location.href = `/course/main`;
            })
            .catch(error => {
                console.error("Error:", error);
                alert(error.message);
            });
    });
</script>
</html>