<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses - Vegan LMS</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>
<header>
  <h1>Vegan delight</h1>
  <nav id="navMenu">
    <a href="/">Home</a>
    <a href="/course/main">Courses</a>
    <a href="/myFridge/main">나의 냉장고</a>
    <a href="login.html" id="loginBtn">Login</a>
    <a href="/post/main" id="">게시판</a>
    <a href="mypage.html" id="">my page</a>
  </nav>
</header>

<!-- Search / Sort / Filter -->
<section class="controls">
  <div class="control" title="강의 검색">
    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M21 21l-4.35-4.35m1.35-5.15a7 7 0 11-14 0 7 7 0 0114 0z" stroke="#6b7280" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <input id="q" placeholder="검색: 강의명" />
  </div>

  <div class="control">
    <select id="category">
      <option value="전체">분야 (전체)</option>
      <option value="LIFE">비건 라이프 스타일</option>
      <option value="RECIPE">요리 레시피</option>
      <option value="SKILL">조리 스킬</option>
    </select>
  </div>
  <button class="cta" id="reset">초기화</button>
</section>

<div class="chips" id="chips">
</div>

<main class="grid" id="grid"></main>

<!-- Video Modal -->
<div class="modal" id="videoModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="videoTitle">강의 재생</div>
      <button class="btn" id="closeVideo">닫기</button>
    </div>
    <div class="modal-body">
      <div class="video" id="videoBox">VIDEO PLAYER</div>
      <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button class="btn primary" id="markComplete">수강 완료</button>
      </div>
    </div>
  </div>
</div>

<!-- Quiz Modal -->
<div class="modal" id="quizModal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-head">
      <div class="modal-title" id="quizTitle">퀴즈</div>
      <button class="btn" id="closeQuiz">닫기</button>
    </div>
    <div class="modal-body">
      <p>문제1</p>
      <button class="btn primary">정답 제출</button>
    </div>
  </div>
</div>

<script>

  // UI refs
  const grid = document.getElementById('grid');
  const q = document.getElementById('q');
  const category = document.getElementById('category');
  const resetBtn = document.getElementById('reset');
  const chips = document.getElementById('chips');

  const videoModal = document.getElementById('videoModal');
  const videoTitle = document.getElementById('videoTitle');
  const closeVideo = document.getElementById('closeVideo');
  const markCompleteBtn = document.getElementById('markComplete');

  const quizModal = document.getElementById('quizModal');
  const quizTitle = document.getElementById('quizTitle');
  const closeQuiz = document.getElementById('closeQuiz');

  let currentCourse = null;
  let state = { q: '', category: '전체' };

  function renderChips() {
    const items = [];
    if (state.q) items.push(`검색: "${state.q}"`);
    if (state.category !== '전체') items.push(`분야: ${state.category}`);
    chips.innerHTML = items.map(t => `<span class="chip">${t}</span>`).join('');
  }

  function render(data = []) {
    // 필터링/검색 로직은 기존과 동일
    const filteredData = data.filter(c => {
      const k = (c.courses_name).toLowerCase();
      const okQ = !state.q || k.includes(state.q.toLowerCase());
      const okC = state.category === '전체' || c.courses_category === state.category;
      return okQ && okC;
    });

    grid.innerHTML = filteredData.map(course=> `
        <article class="card">
            <div class="thumb">
                <span class="badge gray">${course.courses_category}</span>
            </div>
            <div class="card-body">
                <div class="title">${course.courses_name}</div>
                <div class="meta">
                    <span class="badge">${course.courses_category}</span>
                    <span class="badge gray">진도: ${course.duration_sec  || 0}%</span>
                </div>
                <div class="actions">
                    <button class="btn primary" data-play="${course.id}">강의 재생</button>
                    <button class="btn" data-quiz="${course.id}">퀴즈 풀기</button>
                    <span class="badge gray">${course.like_count}</span>
                    <button class="like-btn" data-like="${course.id}">♡</button>
                </div>
            </div>
        </article>
    `).join('');

    renderChips();
  }

  // 초기 로딩 시 백엔드 API 호출
  fetch('/api/courses')
          .then(response => response.json())
          .then(coursesFromApi => {
            // 백엔드에서 가져온 데이터로 화면을 렌더링
            render(coursesFromApi);

            // 검색/필터링 이벤트 리스너를 API 데이터에 연결
            q.addEventListener('input', e => { state.q = e.target.value.trim(); render(coursesFromApi); });
            category.addEventListener('change', e => { state.category = e.target.value; render(coursesFromApi); });
            resetBtn.addEventListener('click', () => {
              state = { q: '', category: '전체' };
              q.value = '';
              category.value = '전체';
              render(coursesFromApi);
            });

            // 나머지 이벤트 리스너들은 기존과 동일하게 유지
          })
          .catch(error => {
            console.error('Error fetching courses:', error);
            alert('강의 목록을 불러오는 데 실패했습니다.');
          });

  // --- Video ---
  function openVideo(course) {
    currentCourse = course;
    videoTitle.textContent = `${course.courses_name}`;
    videoModal.classList.add('open');

    const videoPlayer = `<iframe width="100%" height="315" src="${course.video_url}" frameborder="0" allowfullscreen></iframe>`;
    document.getElementById('videoBox').innerHTML = videoPlayer;
  }
  function closeVideoModal(){ videoModal.classList.remove('open'); }

  // --- data ---
  grid.addEventListener('click', (e) => {
    const playId = e.target.getAttribute('data-play');
    if (playId) {
      // 백엔드 API 호출
      fetch(`/api/courses/${playId}`)
              .then(response => response.json())
              .then(course => {
                // 받은 데이터로 동영상 모달 열기
                openVideo(course);
              })
              .catch(error => console.error('Error fetching course:', error));
    }
  });

  // --- Quiz ---
  function openQuiz(course) {
    if (course.progress < 100) {
      alert("⚠️ 수강 완료 후 퀴즈를 풀 수 있습니다.");
      return;
    }
    currentCourse = course;
    quizTitle.textContent = `퀴즈 · ${course.title}`;
    quizModal.classList.add('open');
  }
  function closeQuizModal(){ quizModal.classList.remove('open'); }

  // Event wiring
  q.addEventListener('input', e => { state.q = e.target.value.trim(); render(); });
  category.addEventListener('change', e => { state.category = e.target.value; render(); });
  resetBtn.addEventListener('click', () => {
    state = { q: '', category: '전체' };
    q.value = '';
    category.value = '전체';
    render();
  });

  closeVideo.addEventListener('click', closeVideoModal);
  videoModal.addEventListener('click', (e)=>{ if(e.target===videoModal) closeVideoModal(); });

  closeQuiz.addEventListener('click', closeQuizModal);
  quizModal.addEventListener('click', (e)=>{ if(e.target===quizModal) closeQuizModal(); });

  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ closeVideoModal(); closeQuizModal(); }
  });

  markCompleteBtn.addEventListener('click', () => {
    if (!currentCourse) return;
    currentCourse.progress = Math.min(100, currentCourse.progress + 100);
    render();
    alert('강의 진도가 100% 증가했습니다.');
  });

  // 추천 상태 저장 (간단 예제용, 실제론 서버 DB 필요)
  // const likes = {}; // { "L1": true, "R2": false }

  grid.addEventListener('click', async (e) => {
    const likeId = e.target.getAttribute('data-like');
    if (likeId) {
      try {
        const response = await fetch(`/api/courses/${likeId}/like`, {
          method: 'POST',
          // Content-Type 헤더를 제거
        });

        if (!response.ok) {
          throw new Error('좋아요 업데이트 실패');
        }

        const updatedCourse = await response.json();

        // UI 갱신 로직
        const likeCountElement = e.target.previousElementSibling;
        likeCountElement.textContent = updatedCourse.like_count;
        e.target.classList.toggle('liked');
        e.target.textContent = '♥';

      } catch (error) {
        console.error('좋아요 업데이트 오류:', error);
        alert('좋아요를 누르는 중 오류가 발생했습니다.');
      }
    }
  });

  // initial paint
  render();
</script>
</body>
</html>