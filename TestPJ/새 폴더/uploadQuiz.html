<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegan LMS - uploadQuiz</title>
    <link rel="stylesheet" href="/css/styleT.css">
</head>
<body>
<header>
    <h1><a th:href="@{/}">Vegan Delight</a></h1>
    <nav id="navMenu">
        <a th:href="@{/teacher/homeT}">홈</a>
        <a th:href="@{/teacher/myCourse}">나의 강의 관리</a>
        <a th:href="@{/teacher/uploadCourse}">강의 등록/퀴즈 출제</a>
        <a th:href="@{/login}">로그인</a>
    </nav>
</header>

<div class="page-wrapper">
    <nav id="subNavT">
        <a href="/teacher/myCourse">나의 강의 관리</a>
        <a href="/teacher/uploadCourse">강의 등록 / 퀴즈 출제</a>
    </nav>

    <main class="uploadQuiz-container">
        <h2>퀴즈 출제</h2>
        <p style="color:#4caf50; font-weight: 600; margin-right: 6px;">
            강의 제목 :<input type="text" th:value="${course.courses_name}" readonly id="coursesName">
        </p>
        <hr>

        <form id="quizUploadForm">
            <input type="hidden" id="coursesId" name="coursesId">

            <div id="quizWrapper">
                <div class="quiz-card">
                    <h3>Q1.</h3>
                    <textarea class="quizCard-area" name="quiz_question" rows="2" placeholder="문제를 입력하세요"></textarea>
                    <label style="font-size: large; font-weight: 600;">정답: </label>
                    <input type="text" name="quiz_result" placeholder="정답 입력">
                    <button type="button" class="remove-quiz-btn" aria-label="퀴즈 삭제">❌</button>
                </div>
            </div>

            <div class="uploadBtns">
                <button id="addQuiz-btn" type="button">문항 추가</button>
                <button id="uploadQuiz-btn" type="submit">출제 완료</button>
                <button type="button" onclick="window.history.back()">닫기</button>
            </div>
        </form>
    </main>
</div>
</body>
<script th:inline="javascript">
    const quizWrapper = document.getElementById("quizWrapper");
    const addQuizBtn = document.getElementById("addQuiz-btn");
    const quizUploadForm = document.getElementById("quizUploadForm");
    let quizCount = 1; // 초기 퀴즈 카드 1개로 시작

    // URL에서 강의 ID(courseId) 추출
    const pathArray = window.location.pathname.split('/');
    const coursesId = pathArray[pathArray.length - 1];
    document.getElementById('coursesId').value = coursesId;

    // 강의 제목 가져오기
    const coursesName = document.getElementById("coursesName").value;

    // 퀴즈 번호 (Q1, Q2, ...)를 재정렬하는 함수
    function updateQuizNumbers() {
        const quizCards = document.querySelectorAll('.quiz-card');
        quizCount = 0; // 카운트 초기화
        quizCards.forEach((card) => {
            quizCount++;
            card.querySelector('h3').textContent = `Q${quizCount}.`;
        });
    }

    // 퀴즈 카드 생성 및 이벤트 리스너 추가 함수 (재사용을 위해 분리)
    function createQuizCard(isInitial) {
        if (!isInitial) {
            quizCount++;
        }

        const newCard = document.createElement("div");
        newCard.className = "quiz-card";
        newCard.innerHTML = `
            <h3>Q${quizCount}.</h3>
            <textarea class="quizCard-area" name="quiz_question" rows="2" placeholder="문제를 입력하세요"></textarea>
            <label style="font-size: large; font-weight: 600;">정답: </label>
            <input type="text" name="quiz_result" placeholder="정답 입력">
            <button type="button" class="remove-quiz-btn" aria-label="퀴즈 삭제">❌</button>
        `;

        // ❌ 버튼 클릭 이벤트 리스너 추가: 해당 카드 삭제
        newCard.querySelector('.remove-quiz-btn').addEventListener('click', function() {
            if (document.querySelectorAll('.quiz-card').length <= 1) {
                alert("최소 1문제는 출제해야 합니다.");
                return;
            }
            if (confirm("이 퀴즈 문항을 삭제하시겠습니까?")) {
                newCard.remove();
                updateQuizNumbers(); // 퀴즈 번호 재정렬
            }
        });

        return newCard;
    }

    // 초기 퀴즈 카드에 삭제 버튼 이벤트 리스너 추가
    const initialCard = document.querySelector('.quiz-card');
    if (initialCard) {
        initialCard.querySelector('.remove-quiz-btn').addEventListener('click', function() {
            if (document.querySelectorAll('.quiz-card').length <= 1) {
                alert("최소 1문제는 출제해야 합니다.");
                return;
            }
            if (confirm("이 퀴즈 문항을 삭제하시겠습니까?")) {
                initialCard.remove();
                updateQuizNumbers();
            }
        });
    }

    // 동적으로 퀴즈 카드 추가 (문항 추가 버튼 이벤트)
    addQuizBtn.addEventListener("click", () => {
        if (quizCount >= 5) {
            alert("최대 5문제까지 출제 가능합니다.");
            return;
        }
        const newCard = createQuizCard(false); // isInitial: false (새로 추가됨)
        quizWrapper.appendChild(newCard);
        updateQuizNumbers(); // 카운트 증가 후 번호 재정렬
    });

    // 폼 제출(출제 완료) 이벤트 처리
    quizUploadForm.addEventListener("submit", function (event) {
        event.preventDefault();

        const formData = new FormData(quizUploadForm);
        const quizzes = [];
        const questions = formData.getAll('quiz_question');
        const results = formData.getAll('quiz_result');

        if (questions.length === 0) {
            alert("출제할 퀴즈 문항이 없습니다.");
            return;
        }

        let isValidationFailed = false;
        for (let i = 0; i < questions.length; i++) {
            const question = questions[i].trim();
            const result = results[i].trim();

            if (question === "" || result === "") {
                isValidationFailed = true;
                break;
            }

            quizzes.push({
                coursesId: coursesId,
                quiz_name: coursesName,
                quiz_question: question,
                quiz_result: result
            });
        }

        if (isValidationFailed) {
            alert("모든 퀴즈의 문제와 정답을 입력해주세요.");
            return;
        }


        fetch("/quiz/upload", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(quizzes)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.message || "퀴즈 출제에 실패했습니다."); });
                }
                return response.json();
            })
            .then(data => {
                alert("강의 등록 및 퀴즈 출제가 완료되었습니다.");
                window.location.href = "/teacher/myCourse";
            })
            .catch(error => {
                console.error("Error:", error);
                alert(error.message);
            });
    });
</script>
</html>