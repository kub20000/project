<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>íšŒì› ê´€ë¦¬ - ê´€ë¦¬ì ëª¨ë“œ</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <header>
    <h1>Vegan Delight - ê´€ë¦¬ì mode<img src="/vegan/supervice/img/íšŒì›ê´€ë¦¬.png" alt="ë§ˆì´í˜ì´ì§€" width="36"></h1>
    <nav id="navMenu">
      <a href="indexmg.html">Home</a>
      <a href="post.html">ê²Œì‹œíŒ</a>
      <a href="usermng.html">íšŒì›ê´€ë¦¬</a>
    </nav>
  </header>
  <main>
    <div class="table-header">
      <h2>íšŒì› ëª©ë¡</h2>
      <div class="search-box">
        <input type="text" id="search" placeholder="ì•„ì´ë”” ê²€ìƒ‰">
        <button id="searchBtn">
          <img src="img/ê²€ìƒ‰.png" alt="ê²€ìƒ‰">
        </button>
      </div>
    </div>

    <table id="userTable">
      <thead>
        <tr>
          <th>id</th>
          <th>ì•„ì´ë””</th>
          <th>ì´ë¦„</th>
          <th>ì´ë©”ì¼</th>
          <th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody>
        <!-- JSì—ì„œ API í˜¸ì¶œ ê²°ê³¼ë¡œ ì±„ì›Œì§ -->
      </tbody>
    </table>
  </main>

  <!-- 1:1 ë¬¸ì˜ ë‹µë³€ ëª¨ë‹¬ -->
  <div id="answerModal">
    <div id="answerModalContent">
      <h3>1:1 ë¬¸ì˜ ë‹µë³€</h3>
      <div id="inquiryText">ë¬¸ì˜ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      <textarea id="answerText" rows="5" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <div style="margin-top:10px; text-align:right;">
        <button onclick="sendAnswer()">ì „ì†¡</button>
        <button onclick="closeAnswerModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = "http://localhost:9090/api"; // ì‹¤ì œ ë°±ì—”ë“œ ì£¼ì†Œë¡œ ë³€ê²½ í•„ìš”
    let currentUserId = null;

    async function fetchUsers() {
      try {
        const res = await fetch(`${API_BASE}/users`);
        if (!res.ok) throw new Error("íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const users = await res.json();
        renderUsers(users);
      } catch (err) {
        alert(err.message);
      }
    }

    function renderUsers(users) {
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";

      users.forEach(user => {
        const tr = document.createElement("tr");

        // 1:1 ë¬¸ì˜ ë²„íŠ¼ í™œì„±í™” ì¡°ê±´
        const answerBtn = user.inquiry && user.inquiry.trim() !== ""
          ? `<button onclick="openAnswerModal(${user.id})">1:1 ë¬¸ì˜ ë‹µë³€</button>`
          : `<button disabled>1:1 ë¬¸ì˜ ë‹µë³€</button>`;

        tr.innerHTML = `
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.name}</td>
          <td>${user.email}</td>
          <td>
            <button onclick="editUser(${user.id})">ìˆ˜ì •</button>
            <button onclick="deleteUser(${user.id})">ì‚­ì œ</button>
            ${answerBtn}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editUser(id) {
      // ê¸°ì¡´ì²˜ëŸ¼ edit.htmlë¡œ ì´ë™
      window.location.href = `edit.html?id=${id}`;
    }

    async function deleteUser(id) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      try {
        const res = await fetch(`${API_BASE}/users/${id}`, { method: "DELETE" });
        if (!res.ok) throw new Error("ì‚­ì œ ì‹¤íŒ¨");
        alert("ì‚­ì œ ì™„ë£Œ");
        fetchUsers();
      } catch (err) {
        alert(err.message);
      }
    }

    async function openAnswerModal(userId) {
      currentUserId = userId;
      try {
        const res = await fetch(`${API_BASE}/users/${userId}/inquiry`);
        if (!res.ok) throw new Error("ë¬¸ì˜ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const data = await res.json();
        document.getElementById("inquiryText").textContent = data.inquiry || "ë¬¸ì˜ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
        document.getElementById("answerModal").style.display = "flex";
      } catch (err) {
        alert(err.message);
      }
    }

    function closeAnswerModal() {
      document.getElementById("answerModal").style.display = "none";
      document.getElementById("answerText").value = "";
    }

    async function sendAnswer() {
      const answer = document.getElementById("answerText").value;
      if (!answer.trim()) {
        alert("ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/users/${currentUserId}/answer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ answer })
        });
        if (!res.ok) throw new Error("ë‹µë³€ ì „ì†¡ ì‹¤íŒ¨");
        alert("ë‹µë³€ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        closeAnswerModal();
      } catch (err) {
        alert(err.message);
      }
    }

    // ì´ˆê¸° ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", fetchUsers);

    // ê²€ìƒ‰ ê¸°ëŠ¥
    document.getElementById("search").addEventListener("input", (e) => {
      const keyword = e.target.value.toLowerCase();
      const rows = document.querySelectorAll("#userTable tbody tr");
      rows.forEach(row => {
        const idCell = row.children[1].textContent.toLowerCase();
        row.style.display = idCell.includes(keyword) ? "" : "none";
      });
    });
    document.getElementById("searchBtn").addEventListener("click", function () {
      const keyword = document.getElementById("search").value.trim();
      if (keyword) {
        alert("ê²€ìƒ‰ ì‹¤í–‰: " + keyword);
        // ğŸ‘‰ ì—¬ê¸°ì„œ ê²€ìƒ‰ í•¨ìˆ˜ ì‹¤í–‰ ë˜ëŠ” ì„œë²„ ìš”ì²­
      } else {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      }
    });
    // form ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
    document.getElementById("searchForm").addEventListener("submit", function (e) {
      e.preventDefault(); // ê¸°ë³¸ form ì œì¶œ ë§‰ê¸° (í˜ì´ì§€ ì´ë™ ë°©ì§€)

      const keyword = document.getElementById("search").value.trim();
      if (keyword) {
        alert("ê²€ìƒ‰ ì‹¤í–‰: " + keyword);
        // ğŸ‘‰ ì—¬ê¸°ì— ê²€ìƒ‰ í•¨ìˆ˜ë‚˜ ì„œë²„ ìš”ì²­ ì½”ë“œ ì‘ì„±
      } else {
        alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      }
    });
  </script>
</body>

</html>