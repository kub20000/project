<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>회원 수정-manager</title>
    <link rel="stylesheet" href="/css/styleM.css">
</head>
<body class="edit">
  <header>
      <h1><a href="/">Vegan Delight</a></h1>
    <nav id="navMenu">
        <a th:href="@{/admin/indexmg}">홈</a>
        <a th:href="@{/manager/postM}">게시판 관리</a>
        <a th:href="@{/admin/usermng}">회원관리</a>
        <a th:href="@{/logout}">로그아웃</a>
    </nav>
  </header>

  <form id="editForm" th:object="${user}">
      <h2>회원 정보 수정</h2>
      <div class="form-group">
          <label>아이디</label>
          <input type="hidden" th:field="*{id}" id="id"/>
          <input type="text" th:field="*{username}" id="username" readonly />
      </div>
      <div class="form-group">
          <label>이름</label>
          <input type="text" th:field="*{name}" id="name"/>
      </div>
      <div class="form-group">
          <label>이메일</label>
          <input type="email" th:field="*{email}" id="email"/>
      </div>
      <div class="form-group">
          <label>관리</label>
          <select th:field="*{role}" id="role">
              <option th:value="${T(com.bproject.user.entity.Role).ADMIN}">Admin</option>
              <option th:value="${T(com.bproject.user.entity.Role).USER}">User</option>
              <option th:value="${T(com.bproject.user.entity.Role).INSTRUCTOR}">Instructor</option>
          </select>
      </div>
      <div class="form-group-btns">
          <button type="submit" id="saveBtn">저장</button>
          <button type="button" id="cancelBtn">취소</button>
      </div>
  </form>

  <script>
      const API_BASE = "/admin";

      // URL에서 id 가져오기
      const pathParts = window.location.pathname.split("/");
      const userId = pathParts[pathParts.length - 1];

      // 사용자 정보 불러오기
      async function fetchUser() {
          try {
              const res = await fetch(`${API_BASE}/users/${userId}`);
              if (!res.ok) return; // 실패해도 아무 메시지 안 띄움
              const user = await res.json();
              document.getElementById("id").value = user.id;
              document.getElementById("username").value = user.username;
              document.getElementById("name").value = user.name;
              document.getElementById("email").value = user.email;
              document.getElementById("role").value = user.role;
          } catch (err) {
              console.log(err); // 콘솔에만 출력
          }
      }

      // 저장 버튼 클릭 시 POST 요청
      document.getElementById("editForm").addEventListener("submit", async (e) => {
          e.preventDefault();

          const updatedUser = {
              username: document.getElementById("username").value,
              name: document.getElementById("name").value,
              email: document.getElementById("email").value,
              role: document.getElementById("role").value
          };

          try {
              const API_BASE = "/api/admin/users";
              const res = await fetch(`${API_BASE}/${userId}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(updatedUser)
              });


              if (!res.ok) {
                  const msg = await res.text();
                  throw new Error(msg);
              }

              alert("수정 완료!");
              window.location.href = "/admin/usermng"; // 목록 페이지 이동
          } catch (err) {
              console.error(err);
              alert("수정 실패: " + err.message);
          }
      });

  </script>
</body>

</html>