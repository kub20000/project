<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비밀번호 변경</title>
    <link rel="stylesheet" href="/style.css">
</head>
<header>
    <h1><a href="/">Vegan Delight</a></h1>
    <nav id="navMenu">
        <a th:href="@{/user/index}">홈</a>
        <a th:href="@{/user/courses}">강의</a>
        <a th:href="@{/user/myFridge}">나의 냉장고</a>
        <a th:href="@{/user/notice}">게시판</a>
        <a th:href="@{/user/login}" >로그인</a>
        <a th:href="@{/user/mypage}">마이페이지</a>
    </nav>
</header>
<body class="changePw">
<main class="form-container">
    <button class="closeBtn">X</button>
    <h3 style="align-self: flex-start;">비밀번호 변경</h3>
    <form id="changePwForm" th:action="@{/user/changePw}" method="post">
        <input class="changePw" type="password" name="nowPw" id="nowPw" placeholder="현재 비밀번호를 입력하세요." required>
        <div style="position: relative;">
            <input type="password" id="newPw" name="password" placeholder="새로운 비밀번호를 입력하세요." required>
            <div id="capsLockWarning" class="caps-warning">Caps Lock이 켜져 있습니다!</div>
            <div id="pwStrength" class="strength"></div>
        </div>
        <input type="password" id="confirmPw" name="confirmPw" placeholder="다시 한 번 입력하세요." required>
        <button type="submit" class="fixInfo">변경</button>
    </form>
</main>

<script>
    const form = document.getElementById("changePwForm");
    const newPwInput = document.getElementById("newPw");
    const confirmPwInput = document.getElementById("confirmPw");
    const strengthDiv = document.getElementById("pwStrength");
    const capsLockWarning = document.getElementById("capsLockWarning");

    // Caps Lock 감지
    newPwInput.addEventListener("keyup", (e) => {
        capsLockWarning.style.display = e.getModifierState("CapsLock") ? "block" : "none";
    });

    // 비밀번호 안전도 검증
    newPwInput.addEventListener("input", () => {
        const pwd = newPwInput.value;
        let strength = "약함";
        let color = "red";

        const regexStrong = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
        const regexMedium = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/;

        if (regexStrong.test(pwd)) {
            strength = "강함";
            color = "green";
        } else if (regexMedium.test(pwd)) {
            strength = "보통";
            color = "orange";
        }

        strengthDiv.textContent = `비밀번호 안전도: ${strength}`;
        strengthDiv.style.color = color;
    });

    // 폼 제출 시 추가 체크
    form.addEventListener("submit", async function(e){
        e.preventDefault();

        const nowPw = document.getElementById("nowPw").value; // 현재 비밀번호
        const newPw = newPwInput.value;                       // 새 비밀번호
        const confirmPw = confirmPwInput.value;              // 새 비밀번호 확인

        // 비밀번호 확인
        if(newPw !== confirmPw){
            alert("비밀번호가 일치하지 않습니다. 다시 입력해주세요.");
            return;
        }

        try {
            const response = await fetch('/api/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nowPw: nowPw,  // 기존 변수 사용
                    newPw: newPw
                })
            });

            const result = await response.json();
            alert(result.message);

            if(response.ok){
                window.location.href = "/user/myinfo"; // 성공 시 이동
            }

        } catch(err){
            console.error(err);
            alert('서버 오류가 발생했습니다.');
        }
    });

    // 닫기 버튼 이벤트 (폼과 별도로)
    document.querySelector('.closeBtn').addEventListener('click', function() {
        history.back();
    });

</script>
</body>

</html>