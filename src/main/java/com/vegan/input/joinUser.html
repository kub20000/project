<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ê°€ì…</title>
    <link rel="stylesheet" href="/img/style.css">
</head>

<body class="joinUser">
<header>
    <h1>Vegan delight</h1>
    <nav id="mainNav">
        <a th:href="@{/user/index}">Home</a>
        <a th:href="@{/courses}">Courses</a>
        <a th:href="@{/user/myFridge}">ë‚˜ì˜ ëƒ‰ì¥ê³ </a>
        <a th:href="@{/user/login}" id="loginBtn">Login</a>
        <a th:href="@{/user/notice}">ê²Œì‹œíŒ</a>
        <a th:href="@{/user/mypage}" class="active"><img th:src="@{/imgs/123.png}" alt="ë§ˆì´í˜ì´ì§€" width="36"></a>
    </nav>
</header>

<main>
    <!-- íšŒì›ê°€ì… í¼ -->
    <form id="entryInfo" th:action="@{/user/joinUser}" method="post">
        <button class="closeBtn" type="button" onclick="confirmExit()">X</button>

        <!-- ì„±ëª… -->
        <div>
            <label for="entryName" style="font-size: large">ì„±ëª…</label>
            <input class="joinUser" type="text" name="name" id="entryName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”." required>
        </div>

        <!-- ì•„ì´ë”” -->
        <div>
            <label for="username">ì•„ì´ë””</label>
            <input class="joinUser" type="text" name="username" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”." required>
            <button class="joinUser" type="button" id="checkUsernameBtn">ì•„ì´ë”” ì¤‘ë³µ í™•ì¸</button>
            <p class="msg" id="usernameMsg"></p>
        </div>

        <!-- ë‹‰ë„¤ì„ -->
        <div>
            <label for="nickname">ë‹‰ë„¤ì„</label>
            <input class="joinUser" type="text" name="nickname" id="nickname" placeholder="ì‚¬ìš©í•˜ì‹¤ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”." required>
            <button class="joinUser" type="button" id="checkNicknameBtn">ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸</button>
            <p class="msg" id="nicknameMsg"></p>
        </div>

        <!-- ë¹„ë°€ë²ˆí˜¸ -->
        <div>
            <label for="entryPw">ë¹„ë°€ë²ˆí˜¸</label>
            <input class="joinUser" type="password" name="password" id="entryPw" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." required>
            <input type="password" name="confirmPw" id="entryPwConfirm" placeholder="í•œ ë²ˆ ë” ì…ë ¥í•˜ì„¸ìš”." required>
            <button class="joinUser" type="button" id="checkPwBtn">ì¼ì¹˜ ì—¬ë¶€ í™•ì¸</button>
            <p class="msg" id="pwMsg"></p>
        </div>

        <!-- ìƒë…„ì›”ì¼ -->
        <div>
            <label for="newbthInfo">ìƒë…„ì›”ì¼</label>
            <input class="joinUser" type="date" name="birthdate" id="newbthInfo" required>
        </div>

        <!-- íœ´ëŒ€ì „í™” -->
        <div>
            <label for="newphoneNum">íœ´ëŒ€ì „í™” ë²ˆí˜¸</label>
            <input class="joinUser" type="tel" id="newphoneNum" name="phone" placeholder="íœ´ëŒ€ì „í™” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." required>
            <p class="msg" id="phoneMsg"></p>
        </div>

        <!-- ì´ë©”ì¼ -->
        <div>
            <label for="newemailInfo">ì´ë©”ì¼ ì •ë³´</label>
            <input class="joinUser" type="email" id="newemailInfo" name="email" placeholder="example@email.com" required>
            <p class="msg" id="emailMsg"></p>
        </div>

        <button class="joinUser" type="submit">íšŒì›ê°€ì…</button>
    </form>

    <div id="successMsg" style="display:none;">
        <h2>íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
        <p>Vegan delightì— ê°€ì…í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ‰</p>
        <button class="joinUser" onclick="location.href='/user/login'">ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™</button>
    </div>
</main>

<script>
    function confirmExit() {
        if (confirm("ì •ë§ë¡œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            window.location.href = "/";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        console.log("DOM loaded!");

        // ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const usernameInput = document.getElementById("username");
        const nicknameInput = document.getElementById("nickname");
        const pwInput = document.getElementById("entryPw");
        const pwConfirmInput = document.getElementById("entryPwConfirm");
        const checkUsernameBtn = document.getElementById("checkUsernameBtn");
        const checkNicknameBtn = document.getElementById("checkNicknameBtn");
        const checkPwBtn = document.getElementById("checkPwBtn");
        const entryForm = document.getElementById("entryInfo");

        const usernameMsg = document.getElementById("usernameMsg");
        const nicknameMsg = document.getElementById("nicknameMsg");
        const pwMsg = document.getElementById("pwMsg");
        const phoneMsg = document.getElementById("phoneMsg");
        const emailMsg = document.getElementById("emailMsg");

        // ì•„ì´ë”” ì¤‘ë³µ ì²´í¬
        if (checkUsernameBtn && usernameInput) {
            checkUsernameBtn.addEventListener("click", () => {
                const username = usernameInput.value.trim();
                if (!username) {
                    usernameMsg.textContent = "ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
                    usernameMsg.style.color = "red";
                    return;
                }
                fetch(`/api/check-username?username=${encodeURIComponent(username)}`)
                    .then(res => res.json())
                    .then(data => {
                        usernameMsg.textContent = data.exists ? "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤." : "ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!";
                        usernameMsg.style.color = data.exists ? "red" : "green";
                    })
                    .catch(err => console.error(err));
            });
        }

        // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
        if (checkNicknameBtn && nicknameInput) {
            checkNicknameBtn.addEventListener("click", () => {
                const nickname = nicknameInput.value.trim();
                if (!nickname) {
                    nicknameMsg.textContent = "ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.";
                    nicknameMsg.style.color = "red";
                    return;
                }
                fetch(`/api/check-nickname?nickname=${encodeURIComponent(nickname)}`)
                    .then(res => res.json())
                    .then(data => {
                        nicknameMsg.textContent = data.exists ? "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤." : "ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!";
                        nicknameMsg.style.color = data.exists ? "red" : "green";
                    })
                    .catch(err => console.error(err));
            });
        }

        // ë¹„ë°€ë²ˆí˜¸ ì²´í¬
        if (checkPwBtn) {
            checkPwBtn.addEventListener("click", () => {
                const pw = pwInput.value;
                const pwConfirm = pwConfirmInput.value;
                if (pw && pwConfirm && pw === pwConfirm) {
                    pwMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.";
                    pwMsg.style.color = "green";
                } else {
                    pwMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    pwMsg.style.color = "red";
                }
            });
        }

        // íšŒì›ê°€ì… ì œì¶œ
        if (entryForm) {
            entryForm.addEventListener("submit", (e) => {
                const name = document.getElementById("entryName")?.value.trim();
                const userId = usernameInput?.value.trim();
                const nickname = nicknameInput?.value.trim();
                const pw = pwInput?.value;
                const pwConfirm = pwConfirmInput?.value;
                const birth = document.getElementById("newbthInfo")?.value;
                const phone = document.getElementById("newphoneNum")?.value.trim();
                const email = document.getElementById("newemailInfo")?.value.trim();

                // ì´ˆê¸°í™”
                pwMsg.textContent = "";
                phoneMsg.textContent = "";
                emailMsg.textContent = "";

                let valid = true;

                // ë¹„ë°€ë²ˆí˜¸
                if (pw !== pwConfirm) {
                    pwMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                    pwMsg.style.color = "red";
                    valid = false;
                } else if (pw && pwConfirm) {
                    const pwRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
                    if (!pwRegex.test(pw)) {
                        pwMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ë©°, ì˜ë¬¸ê³¼ ìˆ«ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.";
                        pwMsg.style.color = "red";
                        valid = false;
                    }
                }

                // ì´ë©”ì¼
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailMsg.textContent = "ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•˜ì„¸ìš”.";
                    emailMsg.style.color = "red";
                    valid = false;
                }

                // ì „í™”ë²ˆí˜¸
                const phoneRegex = /^\d{10,11}$/;
                if (!phoneRegex.test(phone)) {
                    phoneMsg.textContent = "íœ´ëŒ€ì „í™” ë²ˆí˜¸ëŠ” 10~11ìë¦¬ ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”.";
                    phoneMsg.style.color = "red";
                    valid = false;
                }

                // ê²€ì¦ ì‹¤íŒ¨ ì‹œë§Œ ì„œë²„ ì „ì†¡ ë§‰ê¸°
                if (!valid) {
                    e.preventDefault();
                }

            });
        }
    });
</script>
</html>