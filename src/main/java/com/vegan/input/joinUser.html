<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입</title>
    <link rel="stylesheet" href="/img/style.css">
</head>

<body class="joinUser">
<header>
    <h1>Vegan delight</h1>
    <nav id="mainNav">
        <a th:href="@{/user/index}">Home</a>
        <a th:href="@{/courses}">Courses</a>
        <a th:href="@{/user/myFridge}">나의 냉장고</a>
        <a th:href="@{/user/login}" id="loginBtn">Login</a>
        <a th:href="@{/user/notice}">게시판</a>
        <a th:href="@{/user/mypage}" class="active"><img th:src="@{/imgs/123.png}" alt="마이페이지" width="36"></a>
    </nav>
</header>

<main>
    <!-- 회원가입 폼 -->
    <form id="entryInfo" th:action="@{/user/joinUser}" method="post">
        <button class="closeBtn" type="button" onclick="confirmExit()">X</button>

        <!-- 성명 -->
        <div>
            <label for="entryName" style="font-size: large">성명</label>
            <input class="joinUser" type="text" name="name" id="entryName" placeholder="이름을 입력하세요." required>
        </div>

        <!-- 아이디 -->
        <div>
            <label for="username">아이디</label>
            <input class="joinUser" type="text" name="username" id="username" placeholder="아이디를 입력하세요." required>
            <button class="joinUser" type="button" id="checkUsernameBtn">아이디 중복 확인</button>
            <p class="msg" id="usernameMsg"></p>
        </div>

        <!-- 닉네임 -->
        <div>
            <label for="nickname">닉네임</label>
            <input class="joinUser" type="text" name="nickname" id="nickname" placeholder="사용하실 닉네임을 입력하세요." required>
            <button class="joinUser" type="button" id="checkNicknameBtn">닉네임 중복 확인</button>
            <p class="msg" id="nicknameMsg"></p>
        </div>

        <!-- 비밀번호 -->
        <div>
            <label for="entryPw">비밀번호</label>
            <input class="joinUser" type="password" name="password" id="entryPw" placeholder="비밀번호를 입력하세요." required>
            <input type="password" name="confirmPw" id="entryPwConfirm" placeholder="한 번 더 입력하세요." required>
            <button class="joinUser" type="button" id="checkPwBtn">일치 여부 확인</button>
            <p class="msg" id="pwMsg"></p>
        </div>

        <!-- 생년월일 -->
        <div>
            <label for="newbthInfo">생년월일</label>
            <input class="joinUser" type="date" name="birthdate" id="newbthInfo" required>
        </div>

        <!-- 휴대전화 -->
        <div>
            <label for="newphoneNum">휴대전화 번호</label>
            <input class="joinUser" type="tel" id="newphoneNum" name="phone" placeholder="휴대전화 번호를 입력하세요." required>
            <p class="msg" id="phoneMsg"></p>
        </div>

        <!-- 이메일 -->
        <div>
            <label for="newemailInfo">이메일 정보</label>
            <input class="joinUser" type="email" id="newemailInfo" name="email" placeholder="example@email.com" required>
            <p class="msg" id="emailMsg"></p>
        </div>

        <button class="joinUser" type="submit">회원가입</button>
    </form>

    <div id="successMsg" style="display:none;">
        <h2>회원가입이 완료되었습니다!</h2>
        <p>Vegan delight에 가입해주셔서 감사합니다 🎉</p>
        <button class="joinUser" onclick="location.href='/user/login'">로그인 페이지로 이동</button>
    </div>
</main>

<script>
    function confirmExit() {
        if (confirm("정말로 나가시겠습니까?")) {
            window.location.href = "/";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        console.log("DOM loaded!");

        // 요소 가져오기
        const usernameInput = document.getElementById("username");
        const nicknameInput = document.getElementById("nickname");
        const pwInput = document.getElementById("entryPw");
        const pwConfirmInput = document.getElementById("entryPwConfirm");
        const checkUsernameBtn = document.getElementById("checkUsernameBtn");
        const checkNicknameBtn = document.getElementById("checkNicknameBtn");
        const checkPwBtn = document.getElementById("checkPwBtn");
        const entryForm = document.getElementById("entryInfo");

        const usernameMsg = document.getElementById("usernameMsg");
        const nicknameMsg = document.getElementById("nicknameMsg");
        const pwMsg = document.getElementById("pwMsg");
        const phoneMsg = document.getElementById("phoneMsg");
        const emailMsg = document.getElementById("emailMsg");

        // 아이디 중복 체크
        if (checkUsernameBtn && usernameInput) {
            checkUsernameBtn.addEventListener("click", () => {
                const username = usernameInput.value.trim();
                if (!username) {
                    usernameMsg.textContent = "아이디를 입력하세요.";
                    usernameMsg.style.color = "red";
                    return;
                }
                fetch(`/api/check-username?username=${encodeURIComponent(username)}`)
                    .then(res => res.json())
                    .then(data => {
                        usernameMsg.textContent = data.exists ? "이미 사용 중인 아이디입니다." : "사용 가능한 아이디입니다!";
                        usernameMsg.style.color = data.exists ? "red" : "green";
                    })
                    .catch(err => console.error(err));
            });
        }

        // 닉네임 중복 체크
        if (checkNicknameBtn && nicknameInput) {
            checkNicknameBtn.addEventListener("click", () => {
                const nickname = nicknameInput.value.trim();
                if (!nickname) {
                    nicknameMsg.textContent = "닉네임을 입력하세요.";
                    nicknameMsg.style.color = "red";
                    return;
                }
                fetch(`/api/check-nickname?nickname=${encodeURIComponent(nickname)}`)
                    .then(res => res.json())
                    .then(data => {
                        nicknameMsg.textContent = data.exists ? "이미 사용 중인 닉네임입니다." : "사용 가능한 닉네임입니다!";
                        nicknameMsg.style.color = data.exists ? "red" : "green";
                    })
                    .catch(err => console.error(err));
            });
        }

        // 비밀번호 체크
        if (checkPwBtn) {
            checkPwBtn.addEventListener("click", () => {
                const pw = pwInput.value;
                const pwConfirm = pwConfirmInput.value;
                if (pw && pwConfirm && pw === pwConfirm) {
                    pwMsg.textContent = "비밀번호가 일치합니다.";
                    pwMsg.style.color = "green";
                } else {
                    pwMsg.textContent = "비밀번호가 일치하지 않습니다.";
                    pwMsg.style.color = "red";
                }
            });
        }

        // 회원가입 제출
        if (entryForm) {
            entryForm.addEventListener("submit", (e) => {
                const name = document.getElementById("entryName")?.value.trim();
                const userId = usernameInput?.value.trim();
                const nickname = nicknameInput?.value.trim();
                const pw = pwInput?.value;
                const pwConfirm = pwConfirmInput?.value;
                const birth = document.getElementById("newbthInfo")?.value;
                const phone = document.getElementById("newphoneNum")?.value.trim();
                const email = document.getElementById("newemailInfo")?.value.trim();

                // 초기화
                pwMsg.textContent = "";
                phoneMsg.textContent = "";
                emailMsg.textContent = "";

                let valid = true;

                // 비밀번호
                if (pw !== pwConfirm) {
                    pwMsg.textContent = "비밀번호가 일치하지 않습니다.";
                    pwMsg.style.color = "red";
                    valid = false;
                } else if (pw && pwConfirm) {
                    const pwRegex = /^(?=.*[A-Za-z])(?=.*\d).{8,}$/;
                    if (!pwRegex.test(pw)) {
                        pwMsg.textContent = "비밀번호는 8자 이상이며, 영문과 숫자를 포함해야 합니다.";
                        pwMsg.style.color = "red";
                        valid = false;
                    }
                }

                // 이메일
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    emailMsg.textContent = "올바른 이메일 형식을 입력하세요.";
                    emailMsg.style.color = "red";
                    valid = false;
                }

                // 전화번호
                const phoneRegex = /^\d{10,11}$/;
                if (!phoneRegex.test(phone)) {
                    phoneMsg.textContent = "휴대전화 번호는 10~11자리 숫자만 입력하세요.";
                    phoneMsg.style.color = "red";
                    valid = false;
                }

                // 검증 실패 시만 서버 전송 막기
                if (!valid) {
                    e.preventDefault();
                }

            });
        }
    });
</script>
</html>