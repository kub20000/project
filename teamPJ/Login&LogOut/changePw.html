<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</title>
  <link rel="stylesheet" href="styleLogin.css">
</head>
<header>
  <h1><a href="/">Vegan Delight</a></h1>
  <nav id="navMenu">
    <a href="index.html">í™ˆ</a>
    <a href="courses.html">ê°•ì˜</a>
    <a href="myFridge.html">ë‚˜ì˜ ëƒ‰ì¥ê³ </a>
    <a href="main.html">ê²Œì‹œíŒ</a>
    <a href="login.html" id="loginBtn">ë¡œê·¸ì¸</a>
    <a href="mypage.html">ë§ˆì´í˜ì´ì§€</a>
  </nav>
</header>

<body class="changePw">
  <main class="form-container">
    <h3 style="align-self: flex-start;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
    <form id="changePwForm">
      <input class="changePw" type="password" id="nowPw" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." required>
      <div style="position: relative;">
        <input type="password" id="newPw" placeholder="ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”." required>
        <div id="capsLockWarning" class="caps-warning">Caps Lockì´ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤!</div>
        <div id="pwStrength" class="strength"></div>
      </div>
      <input type="password" id="confirmPw" placeholder="ë‹¤ì‹œ í•œ ë²ˆ ì…ë ¥í•˜ì„¸ìš”." required>
      <button class="changePw" type="submit">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
    </form>
  </main>

  <script>
    const form = document.getElementById("changePwForm");
    const newPwInput = document.getElementById("newPw");
    const confirmPwInput = document.getElementById("confirmPw");
    const strengthDiv = document.getElementById("pwStrength");
    const capsLockWarning = document.getElementById("capsLockWarning");

    // Caps Lock ê°ì§€
    newPwInput.addEventListener("keyup", (e) => {
      capsLockWarning.style.display = e.getModifierState("CapsLock") ? "block" : "none";
    });

    // ë¹„ë°€ë²ˆí˜¸ ì•ˆì „ë„ ê²€ì¦
    newPwInput.addEventListener("input", () => {
      const pwd = newPwInput.value;
      let strength = "ì•½í•¨";
      let color = "red";

      const regexStrong = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/;
      const regexMedium = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/;

      if (regexStrong.test(pwd)) {
        strength = "ê°•í•¨";
        color = "green";
      } else if (regexMedium.test(pwd)) {
        strength = "ë³´í†µ";
        color = "orange";
      }

      strengthDiv.textContent = `ë¹„ë°€ë²ˆí˜¸ ì•ˆì „ë„: ${strength}`;
      strengthDiv.style.color = color;
    });

    // // í¼ ì œì¶œ frontend
    // form.addEventListener("submit", function (event) {
    //   event.preventDefault();

    //   const newPw = newPwInput.value;
    //   const confirmPw = confirmPwInput.value;

    //   if (newPw !== confirmPw) {
    //     alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
    //     return;
    //   }

    //   // ì¶”ê°€ ì•ˆì „ë„ ì²´í¬
    //   const regexStrong = /^(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*+\-=_]).{8,}$/;
    //   if (!regexStrong.test(newPw)) {
    //     alert("ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒ, ì†Œë¬¸ì/ìˆ«ì/íŠ¹ìˆ˜ë¬¸ìë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.");
    //     return;
    //   }

    //   alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì •ìƒì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
    //   // ğŸ‘‰ ì„œë²„ ì—°ë™ì´ í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œ fetch/AJAX ì¶”ê°€
    // });

    // í¼ ì œì¶œ backend
    form.addEventListener("submit", async function (event) {
      event.preventDefault();

      const nowPw = document.getElementById("nowPw").value;
      const newPw = newPwInput.value;
      const confirmPw = confirmPwInput.value;

      if (newPw !== confirmPw) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        const res = await fetch("/api/change-password", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nowPw, newPw })
        });

        const data = await res.json();
        if (res.ok) {
          alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì •ìƒì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert("ì‹¤íŒ¨: " + data.message);
        }
      } catch (err) {
        console.error(err);
        alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });
  </script>
</body>

</html>